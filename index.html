<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>‚ö° Microgrid Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      margin: 0;
      padding: 0;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      text-align: center;
      padding: 20px;
    }

    header h1 {
      font-size: 2.2rem;
      margin: 0;
      color: #f1c40f;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      width: 95%;
      max-width: 1300px;
      margin-top: 20px;
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      transition: 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.2);
    }

    .card h2 {
      margin-bottom: 10px;
      font-size: 1.2rem;
      color: #f39c12;
    }

    .value {
      font-size: 1.4rem;
      font-weight: bold;
    }

    canvas {
      margin-top: 10px;
      background: white;
      border-radius: 10px;
      padding: 5px;
      width: 100% !important;
      height: 120px !important;
    }

    /* üîî Notifications panel */
    .notifications {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 915px;
      max-height: 250px;
      overflow-y: auto;
      background: rgba(0,0,0,0.6);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      margin-right: 110px;
      margin-bottom: 15px;
    margin-top: 6px;
    }

    .notification {
      background: rgba(255,255,255,0.1);
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .warning { color: #e74c3c; }
    .info { color: #3498db; }
    .success { color: #2ecc71; }
    .alert { color: #f1c40f; }

  </style>
</head>
<body>
  <header>
    <h1>‚ö° Smart Microgrid Dashboard</h1>
    <p>Real-Time Monitoring (Voltage, Current, Temp, Load, Battery)</p>
  </header>

  <div class="dashboard">
    <div class="card">
      <h2>üîå Voltage</h2>
      <p class="value" id="voltage">-- V</p>
      <canvas id="voltageChart"></canvas>
    </div>
    <div class="card">
      <h2>‚ö° Current</h2>
      <p class="value" id="current">-- A</p>
      <canvas id="currentChart"></canvas>
    </div>
    <div class="card">
      <h2>üå°Ô∏è System Temperature</h2>
      <p class="value" id="temperature">-- ¬∞C</p>
      <canvas id="temperatureChart"></canvas>
    </div>
    <div class="card">
      <h2>üîã Battery</h2>
      <p class="value" id="battery">-- %</p>
      <canvas id="batteryChart"></canvas>
    </div>
    <div class="card">
      <h2>üí° Load</h2>
      <p class="value" id="load">-- kW</p>
      <canvas id="loadChart"></canvas>
    </div>
   

  </div>

  <!-- Notifications Panel -->
  <div class="notifications" id="notifications">
    <h3>üîî Notifications</h3>
  </div>

  <script>
    function setSystemStatus(error = false) {
    const pulse = document.getElementById("statusPulse");
    const text = document.getElementById("statusText");
    if (error) {
      pulse.classList.add("error");
      text.innerText = "‚ö†Ô∏è System Fault Detected";
      text.style.color = "#e74c3c";
    } else {
      pulse.classList.remove("error");
      text.innerText = "Running Smoothly";
      text.style.color = "#2ecc71";
    }
  }

 
    // MQTT Connect
    const client = mqtt.connect("ws://broker.hivemq.com:8000/mqtt");

    client.on("connect", function () {
      console.log("‚úÖ Connected to broker");
      client.subscribe("microgrid/data", function (err) {
        if (!err) {
          console.log("üì° Subscribed to microgrid/data");
        }
      });

      // Demo Publisher (testing only)
      setInterval(() => {
        const demoData = {
          voltage: Math.floor(Math.random() * (250 - 210 + 1)) + 210,
          current: (Math.random() * 15).toFixed(2),
          temperature: (Math.random() * 50).toFixed(1),
          battery: Math.floor(Math.random() * 100),
          load: (Math.random() * 7).toFixed(2)
        };
        client.publish("microgrid/data", JSON.stringify(demoData));
      }, 3000);
    });

    // Chart.js setup helper
    function createChart(ctxId, label, color, unit) {
      const ctx = document.getElementById(ctxId).getContext("2d");
      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: label,
            borderColor: color,
            data: [],
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: { display: true, title: { display: true, text: unit } }
          }
        }
      });
    }

    const charts = {
      voltage: createChart("voltageChart", "Voltage", "#f1c40f", "V"),
      current: createChart("currentChart", "Current", "#2ecc71", "A"),
      temperature: createChart("temperatureChart", "Temperature", "#e74c3c", "¬∞C"),
      battery: createChart("batteryChart", "Battery", "#3498db", "%"),
      load: createChart("loadChart", "Load", "#9b59b6", "kW")
    };

    // Add notification
    function addNotification(message, type="info") {
      const panel = document.getElementById("notifications");
      const div = document.createElement("div");
      div.className = "notification " + type;
      div.innerText = new Date().toLocaleTimeString() + " ‚Üí " + message;
      panel.appendChild(div);
      panel.scrollTop = panel.scrollHeight; // auto scroll
    }

    // On Message
    client.on("message", function (topic, message) {
      try {
        let data = JSON.parse(message.toString());

        // Update values
        document.getElementById("voltage").innerText = data.voltage + " V";
        document.getElementById("current").innerText = data.current + " A";
        document.getElementById("temperature").innerText = data.temperature + " ¬∞C";
        document.getElementById("battery").innerText = data.battery + " %";
        document.getElementById("load").innerText = data.load + " kW";

        const now = new Date().toLocaleTimeString();

        // Update charts
        Object.keys(charts).forEach(key => {
          charts[key].data.labels.push(now);
          charts[key].data.datasets[0].data.push(data[key]);
          if (charts[key].data.labels.length > 10) {
            charts[key].data.labels.shift();
            charts[key].data.datasets[0].data.shift();
          }
          charts[key].update();
        });

        // üîî Alerts/Notifications
        if (data.voltage > 240) addNotification("High Voltage detected ("+data.voltage+" V)", "warning");
        if (data.current > 12) addNotification("Over Current risk ("+data.current+" A)", "alert");
        if (data.temperature > 40) addNotification("High Temperature ("+data.temperature+" ¬∞C)", "warning");
        if (data.battery < 20) addNotification("Low Battery ("+data.battery+"%)", "warning");
        if (data.load > 5) addNotification("Over Load detected ("+data.load+" kW)", "alert");
        
  
      } catch (e) {
        console.error("‚ö†Ô∏è Invalid JSON:", message.toString());
      }
    });
  </script>
</body>
</html>
